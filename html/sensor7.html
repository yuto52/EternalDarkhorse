<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ｒ３ーB１Ｆ_ＥＨ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <input id="fileInput1" type="file" accept=".csv">
    <input id="fileInput2" type="file" accept=".csv">
    <input id="fileInput3" type="file" accept=".csv">
    <input id="date" type="date" min="2024-06-01" max="2024-07-13">
    <button id="plotButton">過去/予測データを表示</button>
    
    <canvas id="myChart1" width="400" height="200"></canvas>
    <canvas id="myChart2" width="400" height="200"></canvas>
    <canvas id="myChart3" width="400" height="200"></canvas>
    
    <script>
        let myChart1 = null;
        let myChart2 = null;
        let myChart3 = null;

        document.getElementById('plotButton').addEventListener('click', function() {
            const fileInput1 = document.getElementById('fileInput1');
            const fileInput2 = document.getElementById('fileInput2');
            const fileInput3 = document.getElementById('fileInput3');
            const dateInput = document.getElementById('date').value;
            
            if (fileInput1.files.length === 0 || fileInput2.files.length === 0 || fileInput3.files.length === 0) {
                alert('すべてのCSVファイルを選択してください。');
                return;
            }
            if (!dateInput) {
                alert('日付を選択してください。');
                return;
            }

            const file1 = fileInput1.files[0];
            const file2 = fileInput2.files[0];
            const file3 = fileInput3.files[0];

            const reader1 = new FileReader();
            const reader2 = new FileReader();
            const reader3 = new FileReader();

            reader1.onload = function(e) {
                const csv = e.target.result;
                const data = parseCSV(csv);
                plotData(data, dateInput, 'myChart1', myChart1, chart => myChart1 = chart, 400, 1200, 'CO2 [ppm]');
            };
            reader1.readAsText(file1);

            reader2.onload = function(e) {
                const csv = e.target.result;
                const data = parseCSV(csv);
                plotData(data, dateInput, 'myChart2', myChart2, chart => myChart2 = chart, 10, 50, '気温 [℃]');
            };
            reader2.readAsText(file2);

            reader3.onload = function(e) {
                const csv = e.target.result;
                const data = parseCSV(csv);
                plotData(data, dateInput, 'myChart3', myChart3, chart => myChart3 = chart, 0, 100, '湿度 [%]');
            };
            reader3.readAsText(file3);
        });

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const result = [];
            const headers = lines[0].split(',');

            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                const currentline = lines[i].split(',');

                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = currentline[j];
                }
                result.push(obj);
            }
            return result;
        }

        function plotData(data, date, canvasId, existingChart, updateChartRef, yMin, yMax, label) {
            const filteredData = data.filter(row => row.ds.startsWith(date));

            if (filteredData.length === 0) {
                alert(`指定された日付のデータがありません (${canvasId})。`);
                return;
            }

            const labels = filteredData.map(row => row.ds);
            const values = filteredData.map(row => parseFloat(row.yhat));

            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // 既存のチャートがあれば破棄
            if (existingChart) {
                existingChart.destroy();
            }

            const newChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: values,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            min: yMin,
                            max: yMax
                        }
                    }
                }
            });

            // チャート参照を更新
            updateChartRef(newChart);
        }
    </script>
</body>
</html>
