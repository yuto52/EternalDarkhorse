<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ｒ３ーB１Ｆ_ＥＨ</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body>
    <input id="date" type="date" min="2024-07-01" max="2024-07-13"></input>
    <button id="plotButton">グラフを表示</button>
    <py-config>
        packages = ["micropip", "pandas", "matplotlib"]
    </py-config>
    <py-script>
        import pandas as pd
        import matplotlib.pyplot as plt
        import matplotlib.dates as mdates
        import matplotlib.ticker as ticker
        from js import document, fetch
        import micropip
        import asyncio
        from pyodide.ffi import create_proxy
        from io import StringIO

        async def load_packages():
            # 必要なパッケージをインストール
            await micropip.install("pandas")
            await micropip.install("matplotlib")

        async def fetch_csv(url):
            response = await fetch(url)
            text = await response.text()
            return text

        async def main():
            await load_packages()

            # CSVファイルのURL
            url = "https://raw.githubusercontent.com/yuto52/EternalDarkhorse/python/predicts/R3-B1F_EH_co2_fcst.csv"
            csv_text = await fetch_csv(url)

            # デバッグ用にCSVデータの内容を表示
            print("CSVデータの内容:\n", csv_text)

            # CSVデータをDataFrameに読み込む
            df = pd.read_csv(StringIO(csv_text))

            # デバッグ用にCSVデータの先頭を表示
            print("CSVデータの先頭:\n", df.head())

            # データフレームの列名を表示
            print("CSVデータの列名:\n", df.columns)

            # 日付取得とグラフ描画
            def plot_graph(event):
                # 入力された日付を取得
                start_date = document.getElementById("date").value
                if not start_date:
                    print("日付を選択してください。")
                    return
                end_date = pd.to_datetime(start_date) + pd.Timedelta(days=1)
                end_date = end_date.strftime('%Y-%m-%d')

                # データをフィルタリング
                filtered_df = df[(df['ds'] >= start_date) & (df['ds'] <= end_date)]

                if filtered_df.empty:
                    print("指定された日付のデータがありません。")
                    return

                # プロット
                fig, ax = plt.subplots(figsize=(10, 6))
                ax.plot(filtered_df['ds'], filtered_df['yhat'])
                ax.set_xlim(pd.to_datetime(start_date), pd.to_datetime(end_date))
                ax.set_ylim(400, 550)  # 縦軸の範囲を設定
                ax.xaxis.set_major_locator(mdates.HourLocator(interval=3))  # 3時間ごとの間隔
                ax.xaxis.set_major_formatter(mdates.DateFormatter('%m/%d\n%H:%M'))

                # 軸のラベルを指定
                ax.set_xlabel('Time')
                ax.set_ylabel('CO2[ppm]')

                # ラベルの間隔を設定
                ax.xaxis.set_major_locator(plt.MaxNLocator(6))  # x軸のラベルの数を減らす
                plt.xticks(rotation=45)  # ラベルを45度回転させて重ならないようにする

                plt.show()

            # 関数をプロキシでラップ
            plot_graph_proxy = create_proxy(plot_graph)
            # ボタンクリックイベントに関数をバインド
            document.getElementById("plotButton").addEventListener("click", plot_graph_proxy)

        # 非同期関数を呼び出す
        asyncio.ensure_future(main())
    </py-script>
</body>
</html>
